<!-- markdownlint-disable MD041 -->

---

<h1 align="center">üç¥ Fork of <a href="https://github.com/siderolabs/talos/">siderolabs/talos</a> to support the Radxa Rock 5B üç¥</h1>

---

# Why does this exist?
Currently, the Radxa Rock 5B, like all other Rockchip RK3588-based boards, requires a BSP kernel.
Additionally, there's no mature EFI bootloader support.

Due to this situation, until/if mainline Linux RK3588 support improves, it's not practical to support the board in its current state in the main Talos codebase.
As a result, this is a "friendly fork": it exists to serve a specific niche and will cease to exist as soon as upstream support is practical.
(I have no affiliation with Sidero Labs! But this is way too extensive & hacky to be reasonable to open a PR for.)

_Please_ be respectful of upstream if you run into any problems.
If there's any doubt about whether an issue is caused by this fork, err on the side of making an issue here first!

# Install
> üíæ I've only tested this using eMMC, but it should work for an SD card as well

Flashable images are available from the [releases](https://github.com/milas/rock5b-talos/releases/latest).

You can write this to your eMMC/SD card using `dd`, Balena Etcher, etc. 

# Machine Configuration
Use the `docker.io/milas/rock5b-talos` images instead of the upstream Talos Linux images.
These include a modified version of Talos to support the Rock 5B in addition to the vendor U-Boot & kernel.

```yaml
machine:
  install:
    # for SD card, use /dev/mmcblk0
    disk: /dev/mmcblk1
    image: docker.io/milas/rock5b-talos:v1.3.3-rock5b
    bootloader: true
    wipe: false
```

# Building
## Kernel
The kernel is built using the config at [`./hack/rock5b/rockchip_linux_defconfig`](https://github.com/milas/rock5b-talos/blob/sbc-rock5b/hack/rock5b/rockchip_linux_defconfig).

Builds are done using [milas/rock5b-docker-build](https://github.com/milas/rock5b-docker-build) which provides a Dockerized toolchain to build the BSP kernel.

To build & push:
```shell
IMAGE="ghcr.io/milas/rock5b-kernel-talos" docker buildx bake --push --set "rock5b-kernel.tags=$IMAGE" rock5b-kernel
```

## Talos Installer (OCI)
The `Makefile` has been modified slightly to allow overriding the kernel context easily.

To build & push:
```shell
IMAGE="ghcr.io/milas/rock5b-kernel-talos@sha256:..."
make installer PUSH=1 IMAGE_NAME="rock5b-talos" EXTRA_CONTEXT="ghcr.io/milas/rock5b-kernel-talos=docker-image://$IMAGE"
```

See `Makefile` for more variables, e.g. `IMAGE_REGISTRY` and `USERNAME`.

New installer container images are published on every commit.

## Flashable Talos Image (`.img.xz`)
You can create a flashable image as well after building & pushing the installer.

See `Makefile` for more variables, e.g. `IMAGE_REGISTRY` and `USERNAME`.

To create in `./_out/`:
```shell
mkdir -p ./_out/
make sbc-rock_5b IMAGE_NAME="rock5b-talos" IMAGE_TAG="latest"
```

# Differences from [siderolabs/talos](https://github.com/siderolabs/talos)
* Support [radxa/u-boot](https://github.com/radxa/u-boot) ([#1](https://github.com/milas/rock5b-talos/issues/1)):
  * Adjust partition offset logic
  * Remove BIOS/EFI partitions entirely
  * Change Talos root partition to ext4 from xfs
  * Add `rk3588-rock-5b.dtb` (& `rk3588-uart7-m2.dtbo`) directly to
    Talos root partition (these would normally be in the EFI partition)
  * Add (hardcoded) `/extlinux/extlinux.conf` directly to Talos
    root partition
    >‚ö†Ô∏è As U-Boot directly boots the kernel (no GRUB), `extlinux.conf`
      contains the kernel args, meaning there's no way to customize them
      right now since it's not templated/generated by the installer! ([#3](https://github.com/milas/rock5b-talos/issues/3))
* Support [radxa/kernel](https://github.com/radxa/kernel):
  * Remove `proc.sys.kernel.yama.ptrace_scope` from KSPP list
  * Disable IMA policy
  * ~~Add new step to `systemRequirements` phase to forcibly load the
    `r8125` ethernet driver ([#2](https://github.com/milas/rock5b-talos/issues/2))~~
  * Increase minimum installer size to account for the BSP kernel
    being ~1GB ([#4](https://github.com/milas/rock5b-talos/issues/4))
  * No-op `SystemInfoController` (no SMBIOS support)

# Resources
* [milas/rock5b-docker-build](https://github.com/milas/rock5b-docker-build)
* [radxa/kernel](https://github.com/radxa/kernel)
* [siderolabs/talos](https://github.com/siderolabs/talos/)

# License

<a href="https://github.com/talos-systems/talos/blob/master/LICENSE">
  <img alt="GitHub" src="https://img.shields.io/github/license/talos-systems/talos?style=flat-square">
</a>

Some software we distribute is under the General Public License family
of licenses or other licenses that require we provide you with the
source code.
If you would like a copy of the source code for this
software, please contact us via email: info at SideroLabs.com.
